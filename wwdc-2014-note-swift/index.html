<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> WWDC 2014 笔记 - Swift · Preferences</title><meta name="description" content="WWDC 2014 笔记 - Swift - stormluke"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://stormluke.me/atom.xml" title="Preferences"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/stormluke" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">WWDC 2014 笔记 - Swift</h1><div class="post-info">Jun 18, 2014</div><div class="post-content"><p>磨蹭到现在才看了一部分的 Session，有些收获，整理一些关于 Swift 语言的内容，主要来自以下几个 Session：</p>
<ul>
<li><a href="https://developer.apple.com/videos/wwdc/2014/?id=402" target="_blank" rel="external">402 Introduction to Swift</a></li>
<li><a href="https://developer.apple.com/videos/wwdc/2014/?id=403" target="_blank" rel="external">403 Intermediate Swift</a></li>
<li><a href="https://developer.apple.com/videos/wwdc/2014/?id=404" target="_blank" rel="external">404 Advanced Swift</a></li>
<li><a href="https://developer.apple.com/videos/wwdc/2014/?id=406" target="_blank" rel="external">406 Integrating Swift with Objective C</a></li>
<li><a href="https://developer.apple.com/videos/wwdc/2014/?id=407" target="_blank" rel="external">407 Swift Interoperability in Depth</a></li>
<li><a href="https://developer.apple.com/videos/wwdc/2014/?id=408" target="_blank" rel="external">408 Swift Playgrounds</a></li>
<li><a href="https://developer.apple.com/videos/wwdc/2014/?id=409" target="_blank" rel="external">409 Introduction to LLDB and The Swift REPL</a></li>
<li><a href="https://developer.apple.com/videos/wwdc/2014/?id=410" target="_blank" rel="external">410 Advanced Swift Debugging in LLDB</a></li>
</ul>
<a id="more"></a>
<p>Apple 已经提供了两种清晰度视频和相应 PDF 的直接下载。另外 <a href="https://github.com/search?q=WWDC" target="_blank" rel="external">GitHub</a> 上也有不少工具能批量下载，其中 <a href="https://github.com/jfahrenkrug/WWDC-Downloader" target="_blank" rel="external">WWDC-Downloader</a> 可以下载 Sample Code。</p>
<p>下面按照 Session 顺序来做些笔记。</p>
<h3 id="Session-402-Introduction-to-Swift"><a href="#Session-402-Introduction-to-Swift" class="headerlink" title="Session 402 - Introduction to Swift"></a>Session 402 - Introduction to Swift</h3><p>看名字就知道不会有啥干货，基本上是概述了 Swift 的各个主要特性，均能在 iBooks 书店里的那本 <em>The Swift Language</em> 中找到。</p>
<h3 id="Session-403-Intermediate-Swift"><a href="#Session-403-Intermediate-Swift" class="headerlink" title="Session 403 - Intermediate Swift"></a>Session 403 - Intermediate Swift</h3><p>主要介绍了以下几个内容：</p>
<ul>
<li>Optionals</li>
<li>内存管理</li>
<li>构造器</li>
<li>闭包</li>
<li>模式匹配</li>
</ul>
<p>虽然都能在 <em>The Swift Language</em> 中找到这些主题，但还是有些值得记下。</p>
<h4 id="Optionals"><a href="#Optionals" class="headerlink" title="Optionals"></a>Optionals</h4><p>Swift 是类型安全（type safe）语言，为了强化这一点，Swift 把下面这坨东西</p>
<p><img src="http://ww4.sinaimg.cn/large/6ad06ebbgw1ehi3u5k6i5j20il0873ys.jpg" alt="old-null"></p>
<p>统一为 Optionals。Swift 支持 Optional Types，表示一个类型的值可能为空，比如 <code>Int?</code>、<code>String?</code>、<code>MyObject?</code> 之类。在类型名后加 <code>?</code> 表示这是一个 Optional Type，因为 Optional Type 值不确定，所以必须声明为变量 <code>var</code>。</p>
<p>Optional Type 有几种解包方式。在变量名后加 <code>!</code> 表示强制解包，若原值为 <code>nil</code> 则会出现运行时错误。较好的方式是使用 <code>if let</code> 语句，可以同时测试原值是否为空并解包：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> neighbors = [<span class="string">"Alex"</span>, <span class="string">"Anna"</span>, <span class="string">"Madison"</span>, <span class="string">"Dave"</span>] <span class="keyword">let</span> index = findIndexOfString(<span class="string">"Anna"</span>, neighbors)</div><div class="line"><span class="keyword">if</span> <span class="keyword">let</span> indexValue = index &#123; <span class="comment">// index is of type Int?</span></div><div class="line">  <span class="built_in">println</span>(<span class="string">"Hello, \(neighbors[indexValue])"</span>)</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="built_in">println</span>(<span class="string">"Must've moved away"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中若 <code>index</code> 有实际值，则 <code>indexValue</code> 会隐式解包并绑定这个值，并且类型为实际类型，在本例中类型为 <code>Int</code>。</p>
<p><code>if let</code> 虽然可以很好地处理一个 Optional Type，但面对多级关系时就会产生嵌套：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> addressNumber: <span class="type">Int</span>?</div><div class="line"><span class="keyword">if</span> <span class="keyword">let</span> home = paul.residence &#123;</div><div class="line">  <span class="keyword">if</span> <span class="keyword">let</span> postalAddress = home.address &#123;</div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> building = postalAddress.buildingNumber &#123;</div><div class="line">      <span class="keyword">if</span> <span class="keyword">let</span> convertedNumber = building.toInt() &#123;</div><div class="line">        addressNumber = convertedNumber</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因此有了 Optional Chaining：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">addressNumber = paul.residence?.address?.buildingNumber?.toInt()</div></pre></td></tr></table></figure>
<p>若中间出现 <code>nil</code>，则会立即停止并返回 <code>nil</code>。</p>
<p><img src="http://ww2.sinaimg.cn/large/6ad06ebbgw1ehi4qmgfejj20za07q0u8.jpg" alt="optional-chaining"></p>
<p>其实 Optional 是一个枚举类型：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Optional</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">case</span> <span class="type">None</span></div><div class="line">  <span class="keyword">case</span> <span class="type">Some</span>(<span class="type">T</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Session 中没提到的是若在类型名后加 <code>!</code>，则会将传入的 Optional Type 隐式解包，比如：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> optionalStr: <span class="type">String</span>? = <span class="string">"Hello"</span>  <span class="comment">// &#123;Some "Hello"&#125;</span></div><div class="line"><span class="keyword">var</span> unwrappedStr: <span class="type">String</span>! = str     <span class="comment">// "Hello"</span></div></pre></td></tr></table></figure>
<h4 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h4><p>Swift 也使用 ARC 做内存管理，所有的引用默认均为强引用，然后就会遇到和 Objective-C 一样的问题。</p>
<p>首先应分清引用的所有权（Ownership），用房间和租户的例子来说明：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apartment</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> tenant: <span class="type">Person</span>?</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> home: <span class="type">Apartment</span>?</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">moveIn</span><span class="params">(apt: Apartment)</span></span> &#123;</div><div class="line">    <span class="keyword">self</span>.home = apt</div><div class="line">    apt.tenant = <span class="keyword">self</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> renters = [<span class="string">"Elsvette"</span>: <span class="type">Person</span>()]</div><div class="line"><span class="keyword">var</span> apts = [<span class="number">507</span>: <span class="type">Apartment</span>()]</div><div class="line">renters[<span class="string">"Elsvette"</span>]!.moveIn(apts[<span class="number">507</span>]!)</div></pre></td></tr></table></figure>
<p>这时的引用关系为：</p>
<p><img src="http://ww2.sinaimg.cn/large/6ad06ebbgw1ehi68hf4oij20dn09q74p.jpg" alt="ownership-strong"></p>
<p>可以看到产生了引用循环。解决方法是在变量声明前加上 <code>weak</code> 修饰符，指明这是一个弱引用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apartment</span> </span>&#123;</div><div class="line">  <span class="keyword">weak</span> <span class="keyword">var</span> tenant: <span class="type">Person</span>?</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">weak</span> <span class="keyword">var</span> home: <span class="type">Apartment</span>?</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">moveIn</span><span class="params">(apt: Apartment)</span></span> &#123;</div><div class="line">    <span class="keyword">self</span>.home = apt</div><div class="line">    apt.tenant = <span class="keyword">self</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> renters = [<span class="string">"Elsvette"</span>: <span class="type">Person</span>()]</div><div class="line"><span class="keyword">var</span> apts = [<span class="number">507</span>: <span class="type">Apartment</span>()]</div><div class="line">renters[<span class="string">"Elsvette"</span>]!.moveIn(apts[<span class="number">507</span>]!)</div></pre></td></tr></table></figure>
<p>此时引用关系为：</p>
<p><img src="http://ww3.sinaimg.cn/large/6ad06ebbgw1ehi6bft5o6j20e509l74p.jpg" alt="ownership-weak-1"></p>
<p>当执行 <code>renters[&quot;Elsvette&quot;]!.moveIn(apts[507]!)</code> 后，<code>renters</code> 取消对 <code>Person</code> 实例的强引用，之后 ARC 释放所有无强引用指向的实例，完成内存回收：</p>
<p><img src="http://ww3.sinaimg.cn/large/6ad06ebbgw1ehi6ll3jc2j207i0963yk.jpg" alt="ownership-weak-2"></p>
<p>关于弱引用有几个需要注意的地方：</p>
<ul>
<li>弱引用一定是 Optional 值</li>
<li>对 Optional 进行 <code>if let</code> 绑定时会产生强引用</li>
<li><code>if</code> 测试弱引用时不会产生强引用</li>
<li>Optional Chaining 在方法调用间不会保存强引用</li>
</ul>
<p>由于弱引用一定是 Optional，而 Optional 必须为 <code>var</code> 变量，在表示同生命周期的关系时可能会遇到无法用 <code>weak</code> 修饰 <code>let</code> 常量声明的问题，比如信用卡和持有者间的关系：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> card: <span class="type">CreditCard</span>?</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditCard</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> holder: <span class="type">Person</span></div><div class="line">  <span class="keyword">init</span>(holder: <span class="type">Person</span>) &#123;</div><div class="line">    <span class="keyword">self</span>.holder = holder</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>解决方式是用 <code>unowned</code> 代替 <code>weak</code> 来修饰 <code>let</code>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> card: <span class="type">CreditCard</span>?</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditCard</span> </span>&#123;</div><div class="line">  <span class="keyword">unowned</span> <span class="keyword">let</span> holder: <span class="type">Person</span></div><div class="line">  <span class="keyword">init</span>(holder: <span class="type">Person</span>) &#123;</div><div class="line">    <span class="keyword">self</span>.holder = holder</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> renters = [<span class="string">"Elsvette"</span>: <span class="type">Person</span>()]</div><div class="line">customers[<span class="string">"Elsvette"</span>]!.saveCard()</div></pre></td></tr></table></figure>
<p>此时的引用图为：</p>
<p><img src="http://ww3.sinaimg.cn/large/6ad06ebbgw1ehi7tbngvjj208a0ev74n.jpg" alt="unowned"></p>
<p>当执行完 <code>customers[&quot;Elsvette&quot;] = nil</code>，<code>renters</code> 取消对 <code>Person</code> 实例的引用，之后 ARC 释放 <code>Person</code> 实例和 <code>CreditCard</code> 实例，完成内存回收。</p>
<p>那么该如何合理使用这三种引用关系（<code>strong</code>、<code>weak</code>、<code>unowned</code>）呢？</p>
<ul>
<li>在所有者指向它所拥有的对象时使用 <code>strong</code></li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/6ad06ebbgw1ehi8arwgg4j20e10alwem.jpg" alt="strong"></p>
<ul>
<li>在生命周期互相独立的对象间使用 <code>weak</code></li>
</ul>
<p><img src="http://ww4.sinaimg.cn/large/6ad06ebbgw1ehi8coq84aj20cs0adq32.jpg" alt="weak"></p>
<ul>
<li>在生命周期相同的关系中，被拥有者指向它的拥有者时使用 <code>unowned</code></li>
</ul>
<p><img src="http://ww3.sinaimg.cn/large/6ad06ebbgw1ehi8cyssxrj204b0a6q2u.jpg" alt="unowned"></p>
<h4 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h4><p>Swift 要求所有的值必须被初始化之后才能使用，因此要注意在构造器中要先初始化完所有成员才能执行它们之上的方法，下面的程序是错的：</p>
<p><img src="http://ww1.sinaimg.cn/large/6ad06ebbgw1ehjfia00tfj20kt0bcta6.jpg" alt="init-error"></p>
<p>另外一个值得注意的地方是父类构造器方法调用的位置，如下例所示：</p>
<p><img src="http://ww2.sinaimg.cn/large/6ad06ebbgw1ehjg4f1ip8j20uk0hq76n.jpg" alt="init-override-error"></p>
<p>由于重载了 <code>fillGasTank</code> 方法，而子类的这个方法中使用了未初始化的 <code>hasTurbo</code> 成员变量导致错误。正确的做法是把 <code>super.init</code> 放在子类构造器方法的最后调用：</p>
<p><img src="http://ww3.sinaimg.cn/large/6ad06ebbgw1ehjjgoal22j20hp08lt9n.jpg" alt="init-override"></p>
<p>Swift 中提供了 <code>convenience</code> 来修饰为便利性而引入的构造方法，各个构造方法间的层次关系应当如下：</p>
<p><img src="http://ww1.sinaimg.cn/large/6ad06ebbgw1ehjgol9vfgj20om0grgnp.jpg" alt="init-hierarchy"></p>
<p>Swift 中还提供了 <code>@lazy</code> 修饰符，被它修饰的变量在第一次使用时才会执行初始化。</p>
<h4 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h4><p>语法什么的不写了。在 Swift 中，闭包也是 ARC 对象，它遵守一切 ARC 的规则。下面这段代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> onTemperatureChange: (<span class="type">Int</span>) -&gt; <span class="type">Void</span> = &#123;&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">logTemperatureDifferences</span><span class="params">(initial: Int)</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> prev = initial</div><div class="line">  onTemperatureChange = &#123; next <span class="keyword">in</span></div><div class="line">    <span class="built_in">println</span>(<span class="string">"Changed \(next - prev)°F"</span>)</div><div class="line">    prev = next</div><div class="line">  &#125;</div><div class="line">&#125;  <span class="comment">// scope ends</span></div></pre></td></tr></table></figure>
<p>的内存结构为：</p>
<p><img src="http://ww1.sinaimg.cn/large/6ad06ebbgw1ehjhx76brhj206r07z3yk.jpg" alt="onTemperatureChange"></p>
<p>另外，函数也是 ARC 对象，下面这段代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> onTemperatureChange: (<span class="type">Int</span>) -&gt; <span class="type">Void</span> = &#123;&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">logTemperatureDifferences</span><span class="params">(initial: Int)</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> prev = initial</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(next: Int)</span></span> &#123;</div><div class="line">    <span class="built_in">println</span>(<span class="string">"Changed \(next - prev)°F"</span>)</div><div class="line">    prev = next</div><div class="line">  &#125;</div><div class="line">  onTemperatureChange = log</div><div class="line">&#125;  <span class="comment">// scope ends</span></div></pre></td></tr></table></figure>
<p>的内存结构也是：</p>
<p><img src="http://ww1.sinaimg.cn/large/6ad06ebbgw1ehjhx76brhj206r07z3yk.jpg" alt="onTemperatureChange-function"></p>
<p>但是这就会有个问题，当在闭包内部引用 <code>self</code> 时会产生循环造成内存泄露：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TemperatureNotifier</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> onChange: (<span class="type">Int</span>) -&gt; <span class="type">Void</span> = &#123;&#125;</div><div class="line">  <span class="keyword">var</span> currentTemp = <span class="number">72</span></div><div class="line">  <span class="keyword">init</span>() &#123;</div><div class="line">    onChange = &#123; temp <span class="keyword">in</span></div><div class="line">      <span class="keyword">self</span>.currentTemp = temp</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://ww4.sinaimg.cn/large/6ad06ebbgw1ehji03m8x8j20790a4aab.jpg" alt="closure-self"></p>
<p>可以想到的解决方法是用 <code>unowned</code> 来处理：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TemperatureNotifier</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> onChange: (<span class="type">Int</span>) -&gt; <span class="type">Void</span> = &#123;&#125;</div><div class="line">  <span class="keyword">var</span> currentTemp = <span class="number">72</span></div><div class="line">  <span class="keyword">init</span>() &#123;</div><div class="line">    <span class="keyword">unowned</span> <span class="keyword">let</span> uSelf = <span class="keyword">self</span></div><div class="line">    onChange = &#123; temp <span class="keyword">in</span></div><div class="line">      uSelf.currentTemp = temp</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://ww3.sinaimg.cn/large/6ad06ebbgw1ehjj9k50ymj206x0a074k.jpg" alt="closure-self-unowned"></p>
<p>其实 Swift 提供了更简洁的写法，即用 <code>[unowned self]</code> 这种语法结构：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TemperatureNotifier</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> onChange: (<span class="type">Int</span>) -&gt; <span class="type">Void</span> = &#123;&#125;</div><div class="line">  <span class="keyword">var</span> currentTemp = <span class="number">72</span></div><div class="line">  <span class="keyword">init</span>() &#123;</div><div class="line">    onChange = &#123;[<span class="keyword">unowned</span> <span class="keyword">self</span>] temp <span class="keyword">in</span></div><div class="line">      <span class="keyword">self</span>.currentTemp = temp</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="模式匹配"><a href="#模式匹配" class="headerlink" title="模式匹配"></a>模式匹配</h4><p>Swift 的模式匹配支持各种体位，可以这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">TrainStatus</span> </span>&#123;</div><div class="line">  <span class="keyword">case</span> <span class="type">OnTime</span></div><div class="line">  <span class="keyword">case</span> <span class="type">Delayed</span>(<span class="type">Int</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">switch</span> trainStatus &#123;</div><div class="line">  <span class="keyword">case</span> .<span class="type">OnTime</span>:</div><div class="line">    <span class="built_in">println</span>(<span class="string">"on time"</span>)</div><div class="line">  <span class="keyword">case</span> .<span class="type">Delayed</span>:</div><div class="line">    <span class="built_in">println</span>(<span class="string">"delayed"</span>)</div></pre></td></tr></table></figure>
<p>这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> trainStatus &#123;</div><div class="line">  <span class="keyword">case</span> .<span class="type">OnTime</span>:</div><div class="line">    <span class="built_in">println</span>(<span class="string">"on time"</span>)</div><div class="line">  <span class="keyword">case</span> .<span class="type">Delayed</span>(<span class="keyword">let</span> minutes):</div><div class="line">    <span class="built_in">println</span>(<span class="string">"delayed by \(minutes) minutes"</span>)</div></pre></td></tr></table></figure>
<p>和这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> trainStatus &#123;</div><div class="line">  <span class="keyword">case</span> .<span class="type">OnTime</span>:</div><div class="line">    <span class="built_in">println</span>(<span class="string">"on time"</span>)</div><div class="line">  <span class="keyword">case</span> .<span class="type">Delayed</span>(<span class="number">1</span>):</div><div class="line">    <span class="built_in">println</span>(<span class="string">"nearly on time"</span>)</div><div class="line">  <span class="keyword">case</span> .<span class="type">Delayed</span>(<span class="number">2</span>...<span class="number">10</span>):</div><div class="line">    <span class="built_in">println</span>(<span class="string">"almost on time, I swear"</span>)</div><div class="line">  <span class="keyword">case</span> .<span class="type">Delayed</span>(<span class="number">_</span>):</div><div class="line">    <span class="built_in">println</span>(<span class="string">"it'll get here when it's ready"</span>)</div></pre></td></tr></table></figure>
<p>甚至这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">VacationStatus</span> </span>&#123;</div><div class="line">  <span class="keyword">case</span> <span class="type">Traveling</span>(<span class="type">TrainStatus</span>)</div><div class="line">  <span class="keyword">case</span> <span class="type">Relaxing</span>(daysLeft: <span class="type">Int</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">switch</span> vacationStatus &#123;</div><div class="line">  <span class="keyword">case</span> .<span class="type">Traveling</span>(.<span class="type">OnTime</span>):</div><div class="line">    tweet(<span class="string">"Train's on time! Can't wait to get there!"</span>)</div><div class="line">  <span class="keyword">case</span> .<span class="type">Traveling</span>(.<span class="type">Delayed</span>(<span class="number">1</span>...<span class="number">15</span>)):</div><div class="line">    tweet(<span class="string">"Train is delayed."</span>)</div><div class="line">  <span class="keyword">case</span> .<span class="type">Traveling</span>(.<span class="type">Delayed</span>(<span class="number">_</span>)):</div><div class="line">    tweet(<span class="string">"OMG when will this train ride end #railfail"</span>)</div></pre></td></tr></table></figure>
<p>匹配类型也是可以的：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">tuneUp</span><span class="params">(car: Car)</span></span> &#123;</div><div class="line">  <span class="keyword">switch</span> car &#123;</div><div class="line">    <span class="keyword">case</span> <span class="keyword">let</span> formulaOne <span class="keyword">as</span> <span class="type">FormulaOne</span>:</div><div class="line">      formulaOne.enterPit()</div><div class="line">    <span class="keyword">case</span> <span class="keyword">let</span> raceCar <span class="keyword">as</span> <span class="type">RaceCar</span>:</div><div class="line">      <span class="keyword">if</span> raceCar.hasTurbo &#123; raceCar.tuneTurbo() &#125;</div><div class="line">      <span class="keyword">fallthrough</span></div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      car.checkOil()</div><div class="line">      car.pumpTires()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>匹配元组就更不用说了：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> color = (<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</div><div class="line"><span class="keyword">switch</span> color &#123;</div><div class="line">  <span class="keyword">case</span> (<span class="number">0.0</span>, <span class="number">0.5</span>...<span class="number">1.0</span>, <span class="keyword">let</span> blue, <span class="number">_</span>):</div><div class="line">    <span class="built_in">println</span>(<span class="string">"Green and \(blue * 100)% blue"</span>)</div></pre></td></tr></table></figure>
<p>还可以加上 <code>where</code> 从句来对匹配结果做进一步约束：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> color &#123;</div><div class="line">  <span class="keyword">case</span> <span class="keyword">let</span> (r, g, b, <span class="number">1.0</span>) <span class="keyword">where</span> r == g &amp;&amp; g == b:</div><div class="line">    <span class="built_in">println</span>(<span class="string">"Opaque grey \(r * 100)%"</span>)</div></pre></td></tr></table></figure>
<p>来看一个综合运用的例子：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">stateFromPlist</span><span class="params">(list: Dictionary)</span></span> -&gt; <span class="type">State</span>? &#123;</div><div class="line">  <span class="keyword">switch</span> (list[<span class="string">"name"</span>], list[<span class="string">"population"</span>], list[<span class="string">"abbr"</span>]) &#123;</div><div class="line">    <span class="keyword">case</span> (.<span class="type">Some</span>(<span class="keyword">let</span> listName <span class="keyword">as</span> <span class="type">NSString</span>),</div><div class="line">          .<span class="type">Some</span>(<span class="keyword">let</span> pop <span class="keyword">as</span> <span class="type">NSNumber</span>),</div><div class="line">          .<span class="type">Some</span>(<span class="keyword">let</span> abbr <span class="keyword">as</span> <span class="type">NSString</span>))</div><div class="line">    <span class="keyword">where</span> abbr.length == <span class="number">2</span>:</div><div class="line">      <span class="keyword">return</span> <span class="type">State</span>(name: listName, population: pop, abbr: abbr)</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>本例中通过运用模式匹配优雅地解决了 <code>AnyObject</code> 类型转换的问题，遇到类型错误会直接静默失败。</p>
<h3 id="Session-404-Advanced-Swift"><a href="#Session-404-Advanced-Swift" class="headerlink" title="Session 404 Advanced Swift"></a>Session 404 Advanced Swift</h3><p>这个 Session 通过构建一个文字游戏来展示了 Swift 中稍深入些的知识。</p>
<h4 id="特殊的协议"><a href="#特殊的协议" class="headerlink" title="特殊的协议"></a>特殊的协议</h4><ul>
<li><code>LogicValue</code>, <code>if logicValue {</code></li>
<li><code>Printable</code>, <code>&quot;\(printable)&quot;</code></li>
<li><code>Sequence</code>, <code>for x in sequence</code></li>
<li><code>IntegerLiteralConvertible</code>, <code>65536</code></li>
<li><code>FloatLiteralConvertible</code>, <code>1.0</code></li>
<li><code>StringLiteralConvertible</code>, <code>&quot;abc&quot;</code></li>
<li><code>ArrayLiteralConvertible</code>, <code>[ a, b, c ]</code></li>
<li><code>DictionaryLiteralConvertible</code>, <code>[ a: x, b: y ]</code></li>
</ul>
<h4 id="定义运算符"><a href="#定义运算符" class="headerlink" title="定义运算符"></a>定义运算符</h4><p>就像下面这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">operator</span> <span class="keyword">infix</span> ~ &#123;&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> ~ <span class="params">(decorator: <span class="params">(Thing)</span></span></span> -&gt; <span class="type">String</span>, object: <span class="type">Thing</span>) -&gt; <span class="type">String</span> &#123;</div><div class="line">  <span class="keyword">return</span> decorator(object)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在定义一个新运算符时要先声明它的前中后缀性。</p>
<h4 id="Subscript"><a href="#Subscript" class="headerlink" title="Subscript"></a>Subscript</h4><p>就像下面这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Place</span> </span>&#123;</div><div class="line">  <span class="keyword">subscript</span>(direction: <span class="type">Direction</span>) -&gt; <span class="type">Place</span>? &#123;</div><div class="line">    <span class="keyword">get</span> &#123;</div><div class="line">      <span class="keyword">return</span> exits[direction]</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">set</span>(destination: <span class="type">Place</span>?) &#123;</div><div class="line">      exits[direction] = destination</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后就可以用 <code>place[&#39;somewhere&#39;]</code> 这种语法了。</p>
<h4 id="泛型和协议"><a href="#泛型和协议" class="headerlink" title="泛型和协议"></a>泛型和协议</h4><p>泛型支持看起来很平凡，似乎只能做 <code>&lt;T: Equatable&gt;</code> 这种的约束，但是人家运行快……</p>
<p>为了更好地和泛型配合，Swift 的协议支持 <code>Self</code> 这种类型，在某类型实现协议时会直接匹配成该类型：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Equatable</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> == <span class="params">(lhs: <span class="keyword">Self</span>, rhs: <span class="keyword">Self</span>)</span></span> -&gt; <span class="type">Bool</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Temperature</span> : <span class="title">Equatable</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> value: <span class="type">Int</span> = <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> == <span class="params">(lhs: Temperature, rhs: Temperature)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">  <span class="keyword">return</span> lhs.value == rhs.value</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h4><p>这个 Session 给出了一个记忆化函数的实现，以递归计算阶乘为例：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">memoize</span><span class="params">( body: <span class="params">(<span class="params">(T)</span></span></span></span>-&gt;<span class="type">U</span>, <span class="type">T</span>)-&gt;<span class="type">U</span> ) -&gt; (<span class="type">T</span>)-&gt;<span class="type">U</span> &#123;</div><div class="line">  <span class="keyword">var</span> memo = <span class="type">DictionaryT</span>, <span class="type">U</span>&gt;()</div><div class="line">  <span class="keyword">var</span> result: ((<span class="type">T</span>)-&gt;<span class="type">U</span>)!</div><div class="line">  result = &#123; x <span class="keyword">in</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> q = memo[x] &#123; <span class="keyword">return</span> q &#125;</div><div class="line">    <span class="keyword">let</span> r = body(result, x)</div><div class="line">    memo[x] = r</div><div class="line">    <span class="keyword">return</span> r</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> factorial = memoize &#123; factorial, x <span class="keyword">in</span> x == <span class="number">0</span> ? <span class="number">1</span> : x * factorial(x - <span class="number">1</span>) &#125;</div></pre></td></tr></table></figure>
<p>分清这三个 <code>factorial</code> 分别是什么就很好理解了。</p>
<h4 id="Swfit-编译器结构"><a href="#Swfit-编译器结构" class="headerlink" title="Swfit 编译器结构"></a>Swfit 编译器结构</h4><p><img src="http://ww1.sinaimg.cn/large/6ad06ebbgw1ehjv9jgddrj20wg0frgo0.jpg" alt="objc-swift"></p>
</div></article></div></main><footer><div class="paginator"><a href="/reactive-programming-note-06/" class="prev">PREV</a><a href="/reactive-programming-note-05/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'stormluke-preferences';
var disqus_identifier = 'wwdc-2014-note-swift/';
var disqus_title = 'WWDC 2014 笔记 - Swift';
var disqus_url = 'http://stormluke.me/wwdc-2014-note-swift/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//stormluke-preferences.disqus.com/count.js" async></script><div class="copyright"><p>© 2012 - 2018 <a href="http://stormluke.me">stormluke</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-60486509-1",'auto');ga('send','pageview');</script></body></html>